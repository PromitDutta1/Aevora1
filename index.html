<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aevora: Timeline Hug Compositor</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        /* Custom styles for the app */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col items-center min-h-screen p-4 sm:p-6">

    <!-- Message Box (Replacement for alert/confirm) -->
    <div id="message-box" class="hidden fixed top-4 z-50 p-3 bg-red-600 text-white rounded-lg shadow-xl text-center transition-opacity duration-300"></div>

    <header class="w-full max-w-4xl text-center mb-8">
        <h1 class="text-4xl font-extrabold text-indigo-700 flex items-center justify-center space-x-2">
            <!-- SVG Icon for Users -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users w-8 h-8"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <span>Aevora: Timeline Hug</span>
        </h1>
        <p class="text-gray-500 mt-2">
            Generate an aesthetic, composite photo of your adult self hugging your younger self. Powered by Gemini.
        </p>
    </header>

    <main class="w-full max-w-4xl bg-white card-shadow rounded-xl p-4 sm:p-8">
        
        <!-- --- API Key Setup Section --- -->
        <section id="api-key-setup" class="mb-8 p-6 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner">
            <h3 class="text-xl font-bold text-yellow-800 mb-3">Authentication Required</h3>
            <p class="text-sm text-yellow-700 mb-4">
                This key is only stored securely in your browser's local storage for future visits.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
                <input
                    id="api-key-input"
                    type="password"
                    placeholder="Enter your Gemini API Key here (e.g., AIza...)"
                    class="flex-grow p-3 border border-yellow-400 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                >
                <button
                    id="save-key-button"
                    class="shrink-0 py-3 px-6 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-200"
                >
                    Unlock App
                </button>
            </div>
        </section>

        <!-- --- Main Application Content (Initially Hidden) --- -->
        <div id="main-content" class="hidden">
            
            <!-- --- Input Section (2-Column Grid) --- -->
            <section id="input-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                
                <!-- Adult Photo Upload -->
                <div id="adult-upload-card" class="p-4 bg-white border border-gray-200 rounded-lg shadow-lg flex flex-col">
                    <h3 class="flex items-center text-lg font-semibold text-gray-700 mb-3">
                        <!-- SVG Icon for User -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user w-6 h-6 text-indigo-500"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <span class="ml-2">1. Recent Photo (Adult)</span>
                    </h3>
                    <label for="adult-photo-upload" id="adult-label" class="block w-full text-center py-4 rounded-lg border-2 cursor-pointer transition duration-200 border-dashed border-indigo-300 hover:border-indigo-500 bg-indigo-50 text-indigo-600">
                        <input id="adult-photo-upload" type="file" accept="image/jpeg, image/png, image/webp" class="hidden">
                        <div class="flex flex-col items-center justify-center">
                            <!-- SVG Icon for UploadCloud -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload-cloud w-6 h-6 mb-1"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>
                            <span class="font-medium text-sm" id="adult-file-status">Click to upload</span>
                        </div>
                    </label>
                    <div id="adult-preview-container" class="mt-3 relative h-40 w-full overflow-hidden rounded-md border border-gray-300 hidden">
                        <img id="adult-preview" alt="Uploaded adult preview" class="absolute inset-0 w-full h-full object-cover">
                    </div>
                </div>

                <!-- Child Photo Upload -->
                <div id="child-upload-card" class="p-4 bg-white border border-gray-200 rounded-lg shadow-lg flex flex-col">
                    <h3 class="flex items-center text-lg font-semibold text-gray-700 mb-3">
                        <!-- SVG Icon for Smile -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-smile w-6 h-6 text-indigo-500"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                        <span class="ml-2">2. Old Photo (Child)</span>
                    </h3>
                    <label for="child-photo-upload" id="child-label" class="block w-full text-center py-4 rounded-lg border-2 cursor-pointer transition duration-200 border-dashed border-indigo-300 hover:border-indigo-500 bg-indigo-500 text-indigo-600">
                        <input id="child-photo-upload" type="file" accept="image/jpeg, image/png, image/webp" class="hidden">
                        <div class="flex flex-col items-center justify-center">
                            <!-- SVG Icon for UploadCloud -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload-cloud w-6 h-6 mb-1"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>
                            <span class="font-medium text-sm" id="child-file-status">Click to upload</span>
                        </div>
                    </label>
                    <div id="child-preview-container" class="mt-3 relative h-40 w-full overflow-hidden rounded-md border border-gray-300 hidden">
                        <img id="child-preview" alt="Uploaded child preview" class="absolute inset-0 w-full h-full object-cover">
                    </div>
                </div>

                <!-- Action Button - Spans full width on mobile/desktop -->
                <div class="md:col-span-2 pt-4">
                     <button
                        id="generate-button"
                        class="w-full py-3 px-4 text-white font-bold rounded-lg shadow-md transition duration-300 transform flex items-center justify-center space-x-2 bg-indigo-400 cursor-not-allowed"
                        disabled
                    >
                        <span id="button-loader" class="hidden">
                            <!-- SVG Icon for Loader2 -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 w-5 h-5 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        </span>
                        <span id="button-text">Create Aevora Image</span>
                    </button>
                </div>
            </section>

            <!-- --- Output Section --- -->
            <section class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center space-x-2">
                    <!-- SVG Icon for Image -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image w-6 h-6"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    <span>Generated Aevora Image</span>
                </h2>

                <div id="output-container" class="relative bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center min-h-[400px]">
                    <!-- Initial State -->
                    <div id="initial-message" class="text-center text-gray-400 p-8">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users w-12 h-12 mx-auto mb-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <p class="text-lg font-medium">Your composite image will appear here.</p>
                        <p class="text-sm mt-1">Upload both photos and click 'Create Aevora Image' to begin.</p>
                    </div>

                    <!-- Generated Image will be inserted here -->
                    <img id="generated-image" class="max-w-full max-h-[70vh] rounded-lg shadow-xl hidden" alt="Generated composite image of adult and child self hugging.">
                    
                    <!-- Loading State Overlay -->
                    <div id="loading-overlay" class="absolute inset-0 bg-white/70 backdrop-blur-sm flex flex-col items-center justify-center p-4 rounded-lg z-10 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 w-10 h-10 text-indigo-500 animate-spin mb-3"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        <p class="text-indigo-600 font-semibold text-lg">
                            Generating your memory... this may take a moment!
                        </p>
                    </div>
                    
                    <!-- Error State -->
                    <div id="error-message" class="p-6 text-center text-red-600 bg-red-50 rounded-lg border border-red-300 hidden">
                        <p class="font-semibold mb-2">Generation Error</p>
                        <p class="text-sm" id="error-text"></p>
                    </div>
                </div>

                <!-- Download Button -->
                <div class="mt-4 flex justify-center">
                    <button id="download-button" class="py-2 px-6 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300 hidden flex items-center space-x-2">
                        <!-- SVG Icon for Download -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        <span>Download Image</span>
                    </button>
                </div>
            </section>
        </div> <!-- End of main-content -->

    </main>

    <script type="module">
        // =================================================================
        // Global State & Constants
        // =================================================================

        let adultFile = null;
        let childFile = null;
        // Key starts as null; loaded from localStorage or set by user input.
        let GEMINI_API_KEY = null; 
        
        const MODEL_NAME = 'gemini-2.5-flash-image-preview';
        const BASE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

        // Combined and optimized prompt, hardcoded
        const HARDCODED_PROMPT = "Create a beautiful, smooth, and aesthetic composition based on the two photos provided. The adult from the recent photo should be tenderly hugging the child from the old photo. The entire background MUST be pure white (#FFFFFF). The style should be photorealistic and artistic. A moment of tender embrace, full of warmth and nostalgia.";

        // =================================================================
        // DOM Element Accessors
        // =================================================================
        const DOMElements = {
            // Key Setup Elements
            apiKeySetup: document.getElementById('api-key-setup'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveKeyButton: document.getElementById('save-key-button'),
            mainContent: document.getElementById('main-content'),

            // Existing App Elements
            adultInput: document.getElementById('adult-photo-upload'),
            childInput: document.getElementById('child-photo-upload'),
            adultLabel: document.getElementById('adult-label'),
            childLabel: document.getElementById('child-label'),
            adultStatus: document.getElementById('adult-file-status'),
            childStatus: document.getElementById('child-file-status'),
            adultPreview: document.getElementById('adult-preview'),
            childPreview: document.getElementById('child-preview'),
            adultPreviewContainer: document.getElementById('adult-preview-container'),
            childPreviewContainer: document.getElementById('child-preview-container'),
            generateButton: document.getElementById('generate-button'),
            buttonLoader: document.getElementById('button-loader'),
            buttonText: document.getElementById('button-text'),
            loadingOverlay: document.getElementById('loading-overlay'),
            generatedImage: document.getElementById('generated-image'),
            initialMessage: document.getElementById('initial-message'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),
            messageBox: document.getElementById('message-box'),
            downloadButton: document.getElementById('download-button'),
        };

        // =================================================================
        // Utility Functions
        // =================================================================

        /**
         * Converts a File object to a Base64 string (data part only).
         * @param {File} file
         * @returns {Promise<string>} Base64 data string
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error("No file provided."));
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the data URL prefix (e.g., 'data:image/jpeg;base64,')
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        /**
         * Custom message box replacement for alert().
         * @param {string} msg 
         * @param {string} [type='error'] - Type for styling (not used for this version, but good practice)
         */
        const showMessage = (msg, type = 'error') => {
             console.log("APP MESSAGE:", msg);
             DOMElements.messageBox.innerText = msg;
             DOMElements.messageBox.classList.remove('hidden');
             // Hide message after 5 seconds
             setTimeout(() => DOMElements.messageBox.classList.add('hidden'), 5000);
        };

        /**
         * Triggers the download of the currently displayed generated image.
         */
        const downloadImage = () => {
            const imageSrc = DOMElements.generatedImage.src;
            if (!imageSrc || !imageSrc.startsWith('data:image/')) {
                showMessage("No image available for download.");
                return;
            }

            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = `Aevora_Timeline_Hug_${new Date().toISOString().slice(0, 10)}.png`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // =================================================================
        // UI Update Functions
        // =================================================================

        /**
         * Toggles the visibility of the main content based on key presence.
         * @param {boolean} isUnlocked 
         */
        const toggleAppVisibility = (isUnlocked) => {
            DOMElements.apiKeySetup.classList.toggle('hidden', isUnlocked);
            DOMElements.mainContent.classList.toggle('hidden', !isUnlocked);
            if (isUnlocked) {
                 showMessage('App unlocked! You can now upload photos.', 'success');
            }
        };

        /**
         * Updates the UI based on the current file and key state.
         */
        const updateUI = () => {
            const isReady = adultFile && childFile && GEMINI_API_KEY;

            // Update button state
            DOMElements.generateButton.disabled = !isReady;
            if (isReady) {
                DOMElements.generateButton.classList.replace('bg-indigo-400', 'bg-indigo-600');
                DOMElements.generateButton.classList.add('hover:bg-indigo-700', 'active:scale-98');
                DOMElements.generateButton.classList.remove('cursor-not-allowed');
            } else {
                DOMElements.generateButton.classList.replace('bg-indigo-600', 'bg-indigo-400');
                DOMElements.generateButton.classList.remove('hover:bg-indigo-700', 'active:scale-98');
                DOMElements.generateButton.classList.add('cursor-not-allowed');
            }
        };

        /**
         * Handles file selection changes.
         * ... (Rest of file change logic is the same)
         */
        const handleFileChange = (e, type) => {
            const file = e.target.files[0];
            const fileStatusEl = type === 'adult' ? DOMElements.adultStatus : DOMElements.childStatus;
            const previewEl = type === 'adult' ? DOMElements.adultPreview : DOMElements.childPreview;
            const previewContainerEl = type === 'adult' ? DOMElements.adultPreviewContainer : DOMElements.childPreviewContainer;
            const labelEl = type === 'adult' ? DOMElements.adultLabel : DOMElements.childLabel;

            if (file) {
                if (type === 'adult') {
                    adultFile = file;
                } else {
                    childFile = file;
                }

                fileStatusEl.textContent = file.name;
                
                labelEl.classList.remove('border-dashed', 'border-indigo-300', 'hover:border-indigo-500', 'bg-indigo-50', 'text-indigo-600');
                labelEl.classList.add('border-green-400', 'bg-green-50', 'text-green-700');

                previewEl.src = URL.createObjectURL(file);
                previewContainerEl.classList.remove('hidden');

            } else {
                if (type === 'adult') {
                    adultFile = null;
                } else {
                    childFile = null;
                }
                
                fileStatusEl.textContent = 'Click to upload';

                labelEl.classList.remove('border-green-400', 'bg-green-50', 'text-green-700');
                labelEl.classList.add('border-dashed', 'border-indigo-300', 'hover:border-indigo-500', 'bg-indigo-50', 'text-indigo-600');

                previewContainerEl.classList.add('hidden');
                previewEl.src = ''; 
            }

            updateUI();
        };

        /**
         * Sets the state of the application to loading or ready.
         */
        const setLoadingState = (isLoading) => {
            DOMElements.loadingOverlay.classList.toggle('hidden', !isLoading);
            DOMElements.buttonLoader.classList.toggle('hidden', !isLoading);
            DOMElements.buttonText.textContent = isLoading ? 'Compositing Timeline...' : 'Create Aevora Image';
            DOMElements.generateButton.disabled = isLoading || !(adultFile && childFile && GEMINI_API_KEY);
        };

        /**
         * Updates the output container to show the generated image or the initial/error state.
         * ... (Output state logic is the same)
         */
        const setOutputState = (state, data = '') => {
            DOMElements.initialMessage.classList.add('hidden');
            DOMElements.generatedImage.classList.add('hidden');
            DOMElements.errorMessage.classList.add('hidden');
            DOMElements.loadingOverlay.classList.add('hidden'); 
            DOMElements.downloadButton.classList.add('hidden'); 

            if (state === 'initial') {
                DOMElements.initialMessage.classList.remove('hidden');
                DOMElements.generatedImage.src = '';
            } else if (state === 'image') {
                DOMElements.generatedImage.src = data;
                DOMElements.generatedImage.classList.remove('hidden');
                DOMElements.downloadButton.classList.remove('hidden'); 
            } else if (state === 'error') {
                DOMElements.errorText.textContent = data;
                DOMElements.errorMessage.classList.remove('hidden');
            }
        };

        // =================================================================
        // Main Generation Logic
        // =================================================================
        
        /**
         * Calls the Gemini Image Generation API.
         * Implements exponential backoff for retries.
         */
        const generateImage = async (adultBase64, childBase64, adultMimeType, childMimeType) => {
            if (!GEMINI_API_KEY) {
                throw new Error("API Key is missing. Please unlock the app first.");
            }
            
            const userQuery = HARDCODED_PROMPT;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: adultMimeType, data: adultBase64 } },
                        { inlineData: { mimeType: childMimeType, data: childBase64 } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            const apiUrlWithKey = `${BASE_API_URL}?key=${GEMINI_API_KEY}`;
            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrlWithKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({}));
                        let errorMessage = errorBody.error?.message || `API returned status ${response.status}`;
                        
                        if (response.status === 400 || response.status === 401) {
                            errorMessage = "API Key Invalid or Restricted. Please ensure your key is correct and has access to image generation.";
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        return `data:image/png;base64,${base64Data}`;
                    } else {
                        throw new Error("Image data was not found in the response or the generation failed. Try different photos.");
                    }

                } catch (err) {
                    attempts++;
                    // Do not log retries as errors
                    if (attempts < maxAttempts) {
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw err;
                    }
                }
            }
        };

        /**
         * Main click handler for the generate button.
         */
        const handleGenerateClick = async () => {
            if (!adultFile || !childFile) {
                showMessage('Please upload both the recent (adult) and old (child) photos.');
                return;
            }
            if (!GEMINI_API_KEY) {
                 showMessage('Please enter your API Key to unlock the application.');
                 return;
            }
            
            setLoadingState(true);
            setOutputState('loading');

            try {
                const adultBase64 = await fileToBase64(adultFile);
                const childBase64 = await fileToBase64(childFile);

                const imageUrl = await generateImage(
                    adultBase64,
                    childBase64,
                    adultFile.type,
                    childFile.type
                );
                
                setOutputState('image', imageUrl);

            } catch (e) {
                console.error("Generation Process Failed:", e);
                setOutputState('error', e.message || "An unknown error occurred during image generation.");
            } finally {
                setLoadingState(false);
            }
        };
        
        /**
         * Handles the API Key submission and saves it to local storage.
         */
        const handleSaveKeyClick = () => {
            const key = DOMElements.apiKeyInput.value.trim();
            // Basic key validation (must start with AIza)
            if (key.length > 20 && key.startsWith('AIza')) { 
                GEMINI_API_KEY = key;
                try {
                    localStorage.setItem('aevoraGeminiApiKey', key);
                } catch (e) {
                    console.error("Local Storage is unavailable:", e);
                }
                toggleAppVisibility(true);
                updateUI();
            } else {
                showMessage("Invalid API Key format. Please ensure you pasted the full key starting with 'AIza'...");
                DOMElements.apiKeyInput.value = '';
            }
        };

        // =================================================================
        // Initialization (Event Listeners & Key Loading)
        // =================================================================

        window.onload = () => {
            // 1. Try to load key from local storage
            const storedKey = localStorage.getItem('aevoraGeminiApiKey');
            if (storedKey && storedKey.length > 20) {
                GEMINI_API_KEY = storedKey;
                toggleAppVisibility(true);
                DOMElements.apiKeyInput.value = storedKey; // Pre-fill the input
            } else {
                toggleAppVisibility(false); // Key setup panel is visible
            }

            // 2. Setup event listeners
            DOMElements.adultInput.addEventListener('change', (e) => handleFileChange(e, 'adult'));
            DOMElements.childInput.addEventListener('change', (e) => handleFileChange(e, 'child'));

            DOMElements.generateButton.addEventListener('click', handleGenerateClick);
            DOMElements.downloadButton.addEventListener('click', downloadImage);
            DOMElements.saveKeyButton.addEventListener('click', handleSaveKeyClick);
            
            // Allow 'Enter' key to submit API key
            DOMElements.apiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSaveKeyClick();
                }
            });

            // 3. Initial UI setup
            setOutputState('initial');
            updateUI();
        };
    </script>
</body>
</html>

